---
- name: Install PostgreSQL
  ansible.builtin.apt:
    name: postgresql
    state: present

- name: Install psycopg2 for Ansible
  ansible.builtin.apt:
    name: python3-psycopg2
    state: present

- name: Ensure PostgreSQL data directory exists
  ansible.builtin.file:
    path: /var/lib/postgresql
    state: directory
    owner: postgres
    group: postgres
    mode: '0755'

- name: Ensure PostgreSQL config directory exists
  ansible.builtin.file:
    path: /etc/postgresql
    state: directory
    owner: postgres
    group: postgres
    mode: '0755'

- name: Start and enable PostgreSQL
  ansible.builtin.service:
    name: postgresql
    state: started
    enabled: true

- name: Create homelab_paas database
  ansible.builtin.shell: |
    su - postgres -c "psql -c 'CREATE DATABASE homelab_paas;'"
  ignore_errors: true

- name: Create dashboard user
  ansible.builtin.shell: |
    su - postgres -c "psql -c \"CREATE USER dashboard WITH PASSWORD 'dashboard123';\""
    su - postgres -c "psql -c 'GRANT ALL PRIVILEGES ON DATABASE homelab_paas TO dashboard;'"
  ignore_errors: true
